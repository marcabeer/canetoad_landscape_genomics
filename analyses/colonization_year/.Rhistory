library(stringr)
library(raster)
library(rangeBuilder)
##########
#load and manipulate occurrence records
gbif_raw<-readLines("ct_gbif.csv")
test<-str_replace_all(gbif_raw[[2]], pattern="\t\t", replacement="\tNA\t")
#replace successive \t with \tNA\t in order to insert missing NAs
##then split strings at \t
gbif_fillna<-list()
gbif_fillna2<-list()
for (i in 1:length(gbif_raw)){
gbif_fillna[[i]]<-str_replace_all(gbif_raw[[i]], pattern="\t\t", replacement="\tNA\t")
gbif_fillna2[[i]]<-strsplit(gbif_fillna[[i]], split="\t")
}
#keep only first 40 fields (some observations are missing later fields)
gbif_fillna_trunc<-list()
for (i in 1:length(gbif_fillna)){
gbif_fillna_trunc[[i]]<-gbif_fillna2[[i]][[1]][c(1:40)]
}
#turn list into df
gbif<-t(as.data.frame(gbif_fillna_trunc))
colnames(gbif)<-c(gbif[1,])
rownames(gbif)<-1:nrow(gbif)
gbif<-gbif[-1,]
gbif<-data.frame(gbif)
library(lubridate)
gbif_ymd<-ymd(paste(gbif$year, gbif$month, gbif$day, sep="-"))
gbif_yeardec<-decimal_date(gbif_ymd)
View(gbif)
library(stringr)
library(raster)
library(rangeBuilder)
#load and manipulate occurrence records
gbif_raw<-readLines("ct_gbif.csv")
#replace successive \t with \tNA\t in order to insert missing NAs
##then split strings at \t
gbif_fillna<-list()
gbif_fillna2<-list()
for (i in 1:length(gbif_raw)){
gbif_fillna[[i]]<-str_replace_all(gbif_raw[[i]], pattern="\t\t", replacement="\tNA\t")
gbif_fillna2[[i]]<-strsplit(gbif_fillna[[i]], split="\t")
}
#keep only first 40 fields (some observations are missing later fields)
gbif_fillna_trunc<-list()
for (i in 1:length(gbif_fillna)){
gbif_fillna_trunc[[i]]<-gbif_fillna2[[i]][[1]][c(1:40)]
}
#turn list into df
gbif<-t(as.data.frame(gbif_fillna_trunc))
colnames(gbif)<-c(gbif[1,])
rownames(gbif)<-1:nrow(gbif)
gbif<-gbif[-1,]
gbif<-data.frame(gbif)
library(lubridate)
gbif_ymd<-ymd(paste(gbif$year, gbif$month, gbif$day, sep="-"))
gbif_yeardec<-decimal_date(gbif_ymd)
#isolate year and coordinates
##swap in gbif$year or yeardec to change temporal resolution (using yeardec and year increments of 0.5 years might provide smoother final raster)
gbif_all<-data.frame(long=as.numeric(gbif$decimalLongitude), lat=as.numeric(gbif$decimalLatitude), year=gbif_yeardec)
#isolate year and coordinates
gbif_all<-data.frame(long=as.numeric(gbif$decimalLongitude), lat=as.numeric(gbif$decimalLatitude), year=gbif_yeardec)
#isolate year and coordinates
gbif_all<-data.frame(long=as.numeric(gbif$decimalLongitude), lat=as.numeric(gbif$decimalLatitude), year=gbif_yeardec)
na_year_index<-which(is.na(gbif_all$year))
gbif_all$year[na_year_index]<-gbif$year[na_year_index]
sum(is.na(gbif_all$year))
#load in sampling metadata for genetic dataset
ct_sites<-read.table("ct_sites.csv", sep=",", header=TRUE)
ct_sites<-data.frame(long=ct_sites$long, lat=ct_sites$lat, year=2010)
#combine gbif observations and those from the genetic dataset
gbif_all<-data.frame(rbind(gbif_all, ct_sites))
gbif_all<-gbif_all[which(gbif_all$lat > -34.5),]
gbif_all<-gbif_all[which(gbif_all$long > 125),]
#remove unlikely occurrence locations (e.g., central Australia in the desert)
gbif_badlat<-gbif_all$lat < -22
gbif_badlong<-gbif_all$long < 140
gbif_badlat_badlong<-gbif_badlat+gbif_badlong
gbif_all<-gbif_all[-which(gbif_badlat_badlong == 2),]
min(gbif_all$year)
#load in raster of Australia (uses part of the elevation raster from the WorldClim database)
##this will be the reference raster that is overwritten by colonization year data
elev_aus<-raster("elev_aus.tif")
spplot(elev_aus)
#replace non-NA values with 1
r_aus<-elev_aus
r_aus[!is.na(r_aus)]<-1
spplot(elev_aus)
spplot(r_aus)
#plot to check geographic distribution of occurrence records
plot(r_aus)
points(gbif_all[which(gbif_all$year<=2011),1:2], pch=16, cex=0.75, col="darkred")
#start at 1937 because it is the first year with >3 unique coordinates (necessary for creating alpha hull)
years<-seq(from=1936, to=2021, by=0.5)
sum(gbif_all$year<=1936)
p2011_coord_uncertainty<-as.numeric(gbif$coordinateUncertaintyInMeters[which(gbif_all$year<=2011)])
quantile(p2011_coord_uncertainty, 0.90, na.rm=TRUE)
